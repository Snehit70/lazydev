import { writeFileSync, mkdirSync, existsSync } from "fs";
import { homedir } from "os";
import { join } from "path";

const HOME = homedir();
const CONFIG_DIR = join(HOME, ".config/lazydev");
const CONFIG_PATH = join(CONFIG_DIR, "config.yaml");

const DEFAULT_CONFIG = `# LazyDev Configuration
# Generated by 'lazydev init'

settings:
  proxy_port: 80
  idle_timeout: 10m
  startup_timeout: 30s
  port_range: [4000, 4999]
  scan_interval: 30s

projects:
  # Add projects with: lazydev add ~/projects/myproject
`;

const DNSMASQ_CONFIG = `# LazyDev DNS - wildcard *.localhost
address=/localhost/127.0.0.1
`;

export async function run() {
  console.log("Initializing LazyDev...\n");
  
  if (!existsSync(CONFIG_DIR)) {
    mkdirSync(CONFIG_DIR, { recursive: true });
    console.log("✓ Created config directory:", CONFIG_DIR);
  }
  
  if (!existsSync(CONFIG_PATH)) {
    writeFileSync(CONFIG_PATH, DEFAULT_CONFIG);
    console.log("✓ Created config file:", CONFIG_PATH);
  } else {
    console.log("  Config file already exists:", CONFIG_PATH);
  }
  
  const dataDir = join(HOME, ".local/share/lazydev");
  if (!existsSync(dataDir)) {
    mkdirSync(dataDir, { recursive: true });
    console.log("✓ Created data directory:", dataDir);
  }
  
  console.log("\n--- DNS Setup (dnsmasq) ---");
  
  const dnsmasqConfPath = "/etc/dnsmasq.d/lazydev";
  const dnsmasqExists = existsSync("/etc/dnsmasq.conf") || existsSync("/etc/dnsmasq.d");
  
  if (dnsmasqExists) {
    console.log("dnsmasq is installed.");
    console.log("\nRun these commands to complete setup:");
    console.log(`  echo '${DNSMASQ_CONFIG.trim()}' | sudo tee ${dnsmasqConfPath}`);
    console.log("  sudo systemctl enable --now dnsmasq");
  } else {
    console.log("dnsmasq not found. Install with:");
    console.log("  sudo dnf install dnsmasq");
    console.log("\nThen run: lazydev init");
    return;
  }
  
  console.log("\n--- Port 80 Setup ---");
  console.log("LazyDev needs port 80 for clean URLs (no port number).");
  console.log("This requires sudo once to allow binding to port 80.");
  console.log("\nRun:");
  console.log("  sudo setcap 'cap_net_bind_service=+ep' $(which bun)");
  console.log("\nThis allows bun to bind to privileged ports without sudo.");
  
  console.log("\n--- Done ---");
  console.log("Next steps:");
  console.log("  1. Add a project: lazydev add ~/projects/myproject");
  console.log("  2. Start daemon:  lazydev start");
  console.log("  3. Access at:     http://myproject.localhost");
}
